{"version":3,"sources":["../../../src/server/routes/api.js"],"names":["Router","require","Book","router","isOwner","book","ctx","addedBy","toString","state","user","_id","isAuthor","comment","authorId","get","getBooks","books","body","status","error","bookId","params","getBook","id","author","description","thumbnail","link","title","comments","map","by","date","content","commentId","result","post","request","addBook","added","message","location","code","patch","Error","updateBook","del","deleteBook","addComment","commentContent","commentIndex","findIndex","deleteComment","module","exports"],"mappings":"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","file":"api.js","sourcesContent":["const Router = require('koa-router');\nconst Book = require('../models/book');\n\nconst router = new Router();\n\n// eslint-disable-next-line no-underscore-dangle\nconst isOwner = (book, ctx) => book.addedBy.toString() === ctx.state.user._id.toString();\nconst isAuthor = (comment, ctx) => comment.authorId.toString() === ctx.state.user._id.toString();\n\nrouter.get('/books', async ctx => {\n  try {\n    const books = await Book.getBooks();\n    ctx.body = 200;\n    ctx.body = books;\n  } catch (error) {\n    ctx.status = 500;\n    ctx.body = { error };\n  }\n});\n\nrouter.get('/books/:bookId', async ctx => {\n  try {\n    const { bookId } = ctx.params;\n    const book = await Book.getBook(bookId);\n    const { id, _id, author, description, thumbnail, link, title, addedBy } = book;\n    const comments = book.comments.map(comment => {\n      const { authorId, by, date, content } = comment;\n      const commentId = comment._id;\n      return { _id: commentId, authorId, by, date, content, isAuthor: isAuthor(comment, ctx) };\n    });\n    const result = {\n      id,\n      _id,\n      author,\n      comments,\n      description,\n      thumbnail,\n      link,\n      title,\n      addedBy,\n      isOwner: isOwner(book, ctx),\n    };\n    ctx.status = 200;\n    ctx.body = result;\n  } catch (error) {\n    ctx.status = 500;\n    ctx.body = { error };\n  }\n});\n\nrouter.post('/books', async ctx => {\n  const book = ctx.request.body;\n  // eslint-disable-next-line no-underscore-dangle\n  book.addedBy = ctx.state.user._id;\n  try {\n    const added = await Book.addBook(book);\n    ctx.status = 201;\n    ctx.body = {\n      message: 'New book created',\n      location: `/books/${added.id}`,\n    };\n  } catch (error) {\n    ctx.status = error.code === 11000 ? 409 : 500;\n    ctx.body = { error };\n  }\n});\n\nrouter.patch('/books/:bookId', async ctx => {\n  try {\n    const { bookId } = ctx.params;\n    const book = ctx.request.body;\n    if (!isOwner(book, ctx)) {\n      throw new Error('Access denied');\n    }\n    const { title, author, description } = book;\n    await Book.updateBook(bookId, { title, author, description });\n    ctx.status = 204;\n  } catch (error) {\n    ctx.status = 500;\n    ctx.body = { error };\n  }\n});\n\nrouter.del('/books/:bookId', async ctx => {\n  try {\n    const { bookId } = ctx.params;\n    const book = await Book.getBook(bookId);\n    if (!isOwner(book, ctx)) {\n      throw new Error('Access denied');\n    }\n    await Book.deleteBook(bookId);\n    ctx.status = 204;\n  } catch (error) {\n    ctx.status = 500;\n    ctx.body = { error };\n  }\n});\n\nrouter.post('/books/:bookId/comments', async ctx => {\n  const { content } = ctx.request.body;\n  const { bookId } = ctx.params;\n  const user = ctx.state.user;\n  try {\n    const book = await Book.addComment(bookId, user, content);\n    ctx.status = 201;\n    const comments = book.comments.map(comment => {\n      const { authorId, by, date } = comment;\n      const commentId = comment._id;\n      const commentContent = comment.content;\n      return {\n        _id: commentId,\n        authorId,\n        by,\n        date,\n        content: commentContent,\n        isAuthor: isAuthor(comment, ctx),\n      };\n    });\n    ctx.body = comments;\n  } catch (error) {\n    ctx.status = 500;\n    ctx.body = { error };\n  }\n});\n\nrouter.del('/books/:bookId/comments/:commentId', async ctx => {\n  const { bookId, commentId } = ctx.params;\n  try {\n    const book = await Book.getBook(bookId);\n    const commentIndex = book.comments.findIndex(comment => comment._id.toString() === commentId);\n    if (!isAuthor(book.comments[commentIndex], ctx) && !isOwner(bookId, ctx)) {\n      throw new Error('Access denied');\n    }\n    const result = await Book.deleteComment(bookId, commentId);\n    const comments = result.comments.map(comment => {\n      const { _id, authorId, by, date, content } = comment;\n      return { _id, authorId, by, date, content, isAuthor: isAuthor(comment, ctx) };\n    });\n    ctx.status = 200;\n    ctx.body = comments;\n  } catch (error) {\n    ctx.status = 500;\n    ctx.body = { error };\n  }\n});\n\nmodule.exports = router;\n"]}